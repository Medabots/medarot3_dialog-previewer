<?php
$charwidthtable=array(
	array(
		2, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		2, 1, 3, 5, 4, 5, 5, 2, 2, 2, 3, 5, 2, 4, 1, 4,
		4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 2, 4, 4, 4, 5,
		5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
		5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 2, 4, 2, 3, 4,
		2, 5, 4, 4, 4, 4, 4, 4, 4, 1, 2, 4, 1, 5, 4, 4,
		4, 4, 4, 4, 4, 4, 4, 5, 4, 4, 4, 3, 1, 3, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7
	),
	array(
		2, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 6, 5,
		2, 1, 3, 5, 4, 5, 5, 2, 2, 2, 3, 5, 2, 4, 1, 4,
		4, 2, 4, 4, 4, 4, 4, 4, 4, 4, 1, 2, 4, 4, 4, 4,
		5, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 4, 4, 5, 4, 4,
		4, 4, 4, 4, 5, 4, 5, 5, 5, 5, 4, 2, 4, 2, 3, 4,
		2, 3, 3, 3, 3, 3, 2, 3, 3, 1, 2, 3, 1, 5, 3, 3,
		3, 3, 3, 3, 3, 3, 4, 5, 4, 3, 3, 3, 1, 3, 6, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7
	),
	array(
		2, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		2, 2, 3, 5, 5, 5, 6, 2, 3, 3, 3, 5, 2, 4, 1, 4,
		5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 1, 2, 4, 4, 4, 6,
		6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
		6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 4, 3, 3, 4,
		2, 6, 5, 5, 5, 5, 4, 5, 5, 2, 3, 5, 2, 6, 5, 5,
		5, 5, 5, 5, 5, 5, 5, 6, 6, 5, 4, 4, 2, 4, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7
	),
	array(
		2, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		2, 1, 3, 5, 4, 5, 5, 1, 2, 2, 3, 5, 2, 4, 1, 4,
		4, 2, 4, 4, 4, 4, 4, 4, 4, 4, 1, 2, 4, 4, 4, 5,
		5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
		5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 2, 4, 2, 3, 4,
		2, 4, 4, 4, 4, 4, 4, 4, 4, 1, 2, 4, 1, 5, 4, 4,
		4, 4, 4, 4, 4, 4, 4, 5, 5, 4, 4, 3, 1, 3, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7
	),
	array(
		2, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		2, 2, 3, 5, 5, 5, 6, 1, 3, 3, 3, 5, 2, 4, 1, 4,
		5, 3, 5, 5, 5, 5, 5, 5, 5, 5, 1, 2, 4, 4, 4, 6,
		6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
		6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 3, 4, 3, 3, 4,
		2, 5, 5, 5, 5, 5, 5, 5, 5, 2, 3, 5, 2, 6, 5, 5,
		5, 5, 5, 5, 5, 5, 5, 6, 6, 5, 5, 4, 2, 4, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,
		7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7
	)
);
$fonts=array(
	false,
	false,
	false,
	false,
	false
);
$fontsloaded=array(
	false,
	false,
	false,
	false,
	false
);
$numberoffonts=5;
$linea=$_REQUEST['la'].'';
$lineb=$_REQUEST['lb'].'';

$font=trim($_REQUEST['f'].'');
$font=intval($font,10);
if($font>=$numberoffonts||$font<0) {
	$font=0;
}

$lastpage=trim($_REQUEST['e'].'');
$lastpage=(intval($lastpage,10)>0?true:false);

$windowless=trim($_REQUEST['ww'].'');
$windowless=(intval($windowless,10)>0?true:false);

$fontsloaded[$font]=true;

$portrait=$_REQUEST['p'];

// Parse lines.

$lines=array();
$lines[0]='';
if(isset($_REQUEST['la'])) {
	$lines[0]=$_REQUEST['la'];
}
$lines[1]='';
if(isset($_REQUEST['lb'])) {
	$lines[1]=$_REQUEST['lb'];
}
mb_substitute_character(ord('?'));
$linelengths=array(0,0);
foreach($lines as $linenum => $linetext) {

	// Fix early termination by linebreak by truncating the text where one is found.
	
	$linetext=explode("\n",$linetext);
	$linetext=explode("\r",$linetext[0]);
	$linetext=$linetext[0];
	
	// Replace ASCII control characters and tabs with ?.
	
	$linetext=preg_replace('/[\x00-\x1F\x7F]/','?',$linetext);
	
	// Remove speed control code.
	
	$linetext=preg_replace('/\<S[0-9A-Fa-f][0-9A-Fa-f]\>/','',$linetext);
	
	// Re-encode note character.
	
	$note=chr(0xF0).chr(0x9D).chr(0x85).chr(0xA0);
	$notefinal=chr(0x1E);
	$linetext=str_replace($note,$notefinal,$linetext);
	
	// Re-encode yen character.
	
	$yen=chr(0xC2).chr(0xA5);
	$yenfinal=chr(0x1F);
	$linetext=str_replace($yen,$yenfinal,$linetext);
	
	// Convert any remaining UTF8 characters to ?.
	
	$linetext=mb_convert_encoding($linetext,'ASCII','UTF8');
	
	// Make damn sure there are no stragglers in the $80 to $FF range.
	
	$linetext=preg_replace('/[\x80-\xFF]/','?',$linetext);
	
	// Process literal byte codes.
	
	$matches=array();
	while(preg_match('/\<\$[0-9A-Fa-f][0-9A-Fa-f]\>/',$linetext,$matches,PREG_OFFSET_CAPTURE)) {
		$match=$matches[0][0];
		$pos=intval($matches[0][1],10);
		$len=strlen($match);
		$byteord=hexdec(substr($match,1,-1));
		if($byteord==0xCD) {
			$replace='<CD>';
		} else if($byteord==0xCF) {
			$replace='<CF>';
		} else if($byteord==0xD1) {
			$replace='<D1>';
		} else if($byteord==0xD3) {
			$replace='<D3>';
		} else {
			$replace=chr($byteord%128);
		}
		$linetext=substr($linetext,0,$pos).$replace.substr($linetext,$pos+$len);
		$matches=array();
	}
	
	// Fix early termination by newline control codes.
	
	$linetext=explode("<CD>",$linetext);
	$linetext=explode("<CF>",$linetext[0]);
	$linetext=explode("<Cd>",$linetext[0]);
	$linetext=explode("<Cf>",$linetext[0]);
	$linetext=explode("<D1>",$linetext[0]);
	$linetext=explode("<D3>",$linetext[0]);
	$linetext=$linetext[0];
	
	// Clean up kanji replace code.
	
	$linetext=preg_replace('/\<K[0-9A-Fa-f][0-9A-Fa-f]\>/','?',$linetext);
	
	// Fix early termination by end code.
	
	$linetext=preg_replace('/\<\*[0-9A-Fa-f][0-9A-Fa-f]\>/','<*00>',$linetext);
	$linetext=explode("<*00>",$linetext);
	if(count($linetext)>1) {
		
		// Assume that there isn't a next page if an endcode is found.
		
		$lastpage=true;
	}
	$linetext=$linetext[0];
	
	// Replace subtext with character $01 repeated 8 times.
	
	$placeholder=chr(0x01);
	$placeholder.=$placeholder;
	$placeholder.=$placeholder;
	$placeholder.=$placeholder;
	$linetext=preg_replace('/\<\&[0-9A-Za-z\_\-]+\>/',$placeholder,$linetext);
	
	// Process all portrait codes.
	
	$matches=array();
	while(preg_match('/\<\@[0-9A-Za-z\s\,]+\>/',$linetext,$matches,PREG_OFFSET_CAPTURE)) {
	
		// For each match in order update the current portrait variable and remove the replace code from the system.
		
		$match=$matches[0][0];
		$pos=intval($matches[0][1],10);
		$len=strlen($match);
		$linetext=substr($linetext,0,$pos).substr($linetext,$pos+$len);
		$portrait=substr($match,2,-1);
		$matches=array();
	}
	
	// Replace font control codes with single byte placeholders.
	
	$i=0;
	while($i<$numberoffonts) {
		
		// We are assuming that ponts go no higher than 9.
		// Since $80 onwards is not used in our font we can abuse it for single byte placeholders for this control code, for ease of parsing.
		// $80 = <f00>, $81 = <f01>, etc. This is only for the purposes of this script, this isn't used anywhere else.
		
		$placeholder=chr(0x80+$i);
		$linetext=str_replace('<f0'.$i.'>',$placeholder,$linetext);
		$i++;
	}
	
	// Store modified text.
	
	$lines[$linenum]=$linetext;
	
	// Count text length in pixels.
	// Strings can be uses as char arrays in php.
	
	$i=0;
	$c=strlen($linetext);
	$fontforcounting=$font;
	while($i<$c) {
		$char=$linetext[$i];
		$charcode=ord($char);
		if($charcode<0x80) {
		
			// Add to pixel length total.
			
			$linelengths[$linenum]+=$charwidthtable[$fontforcounting][$charcode]+1;
		} else {
			
			// A font switching single byte placeholder was encountered.
			// Switch font tables and note that the font file needs to be loaded.
			
			$fontforcounting=$charcode-0x80;
			if($fontforcounting>=$numberoffonts||$fontforcounting<0) {
				$fontforcounting=0;
			}
			$fontsloaded[$fontforcounting]=true;
		}
		$i++;
	}
}

// Separate portrait data. This allows for the field to be empty.

list($orientation,$portraitcharacter,$portraitexpression)=explode(',',$portrait.',,');

// Parse orientation.
// If the orientation isn't LL/LR/RL/RR then assume CC.

$orientation=trim(strtolower($orientation));
$rightside=false;
$rightfacing=false;
$showportrait=true;
switch($orientation) {
	case 'll':
		break;
	case 'lr':
		$rightfacing=true;
		break;
	case 'rl':
		$rightside=true;
		break;
	case 'rr':
		$rightside=true;
		$rightfacing=true;
		break;
	default:
		$showportrait=false;
		$orientation='cc';
}

// Parse character index.
// There are 80 characters. The 81st is for characters specified outside that range.

$portraitcharacter=preg_replace('/[^0-9a-f]/','',strtolower($portraitcharacter));
if(empty($portraitcharacter)) {
	$portraitcharacter=0;
} else {
	$portraitcharacter=substr($portraitcharacter,-2);
	$portraitcharacter=hexdec($portraitcharacter);
}
$portraitcharacter=$portraitcharacter%256;

if($portraitcharacter>80) {
	$portraitcharacter=80;
}

// Parse expression index.
// Each character is expected to have exactly 64 expressions. No more, no less. 

$portraitexpression=preg_replace('/[^0-9a-f]/','',strtolower($portraitexpression));
if(empty($portraitexpression)) {
	$portraitexpression=0;
} else {
	$portraitexpression=substr($portraitexpression,-2);
	$portraitexpression=hexdec($portraitexpression);
}
$portraitexpression=$portraitexpression%256;

if($portraitexpression>63) {
	$portraitexpression=63;
}

// Set basic size and positioning variables.
// Windowless prints text without the messagebox and without truncating text.

$portraithorizontaloffset=0;
$windowverticaloffset=0;
if($windowless) {
	$canvaswidth=32;
	$canvasheight=16;
	$textverticaloffset=0;
	$texthorizontaloffset=0;
	$textlineheight=8;
	
	// Adapt canvas width to the content.
	
	foreach($linelengths as $linenum => $linelength) {
		if($linelength>$canvaswidth) {
			$canvaswidth=$linelength;
		}
	}
	$canvaswidth=$canvaswidth-($canvaswidth%8)+8;
} else {
	$canvaswidth=160;
	$canvasheight=40;
	$textverticaloffset=8;
	$texthorizontaloffset=8;
	$textlineheight=16;
}

// Load portrait image.

$portraitim=false;
if($showportrait) {
	
	// Modify canvas height and messagebox position to accommodate a portrait.
	
	$canvasheight+=32;
	$windowverticaloffset+=32;
	$textverticaloffset+=32;
	
	// Load the portrait image.
	
	$portraitim=imagecreatefrompng('./portraits/'.$portraitcharacter.'/'.$portraitexpression.'.png');
	
	// Change the horizontal position to right-align the portrait if required.
	
	if($rightside) {
		$portraithorizontaloffset=$canvaswidth-32;
	}
	
	// Flip the image if required.
	
	if($rightfacing) {
		imageflip($portraitim,IMG_FLIP_HORIZONTAL);
	}
}

// Check if either line overflows.

$errortop=($linelengths[0]>137?true:false);
$errorbottom=($linelengths[1]>137?true:false);

// Load appropriate window image.

$windowim=imagecreatefrompng('./window/'.($errortop?($errorbottom?'error-both-':'error-top-'):($errorbottom?'error-bottom-':'')).($lastpage?'last':'next').'-page.png');

// Load required fonts and make font background transparent.
// This traverses each pixel, checks if it is white, and then if so makes it transparent.

foreach($fontsloaded as $fontnum => $fontsloadedtest) {
	if($fontsloadedtest) {
		$fonts[$fontnum]=imagecreatefrompng('./fonts/'.$fontnum.'.png');
		$transparent=imagecolorallocatealpha($fonts[$fontnum],0,0,0,127);
		$width=128;
		$height=64;
		imagealphablending($fonts[$fontnum],false);
		$x=0;
		while($x<$width) {
			$y=0;
			while($y<$height) {
				$rgb = imagecolorat($fonts[$fontnum],$x,$y);
				$r = ($rgb >> 16) & 0xFF;
				$g = ($rgb >> 8) & 0xFF;
				$b = $rgb & 0xFF;
				if($r==255&&$g==255&&$b==255) {
					imagesetpixel($fonts[$fontnum],$x,$y,$transparent);
				}
				$y++;
			}
			$x++;
		}
		imagealphablending($fonts[$fontnum],true);
	}
}

// Create our canvas for compositing images.

$im=imagecreatetruecolor($canvaswidth,$canvasheight);

// Make the background transparent.

imagealphablending($im,false);
$transparent=imagecolorallocatealpha($im,0,0,0,127);
imagefill($im,0,0,$transparent);
imagealphablending($im,true);

// Insert window into canvas image if applicable.

if($windowless) {
	
	// Apply an opaque white background for windowless text unless we specify otherwise.
	
	if(!$lastpage) {
		$white=imagecolorallocatealpha($im,255,255,255,0);
		imagefilledrectangle($im,0,$windowverticaloffset,$canvaswidth-1,$canvasheight-1,$white);
	}
} else {
	imagecopy($im,$windowim,0,$windowverticaloffset,0,0,160,40);
	imagedestroy($windowim);
}

// Insert portrait into canvas image.

if($showportrait) {
	imagecopy($im,$portraitim,$portraithorizontaloffset,0,0,0,32,32);
	imagedestroy($portraitim);
}

// Draw text.

$linelengths=array(0,0);
foreach($lines as $linenum => $linetext) {
	$i=0;
	$c=strlen($linetext);
	while($i<$c) {

		// If the length of the current printed text is 136 then don't draw... unless in windowless mode.

		if($linelengths[$linenum]<136||$windowless) {
			$char=$linetext[$i];
			$charcode=ord($char);
			if($charcode<0x80) {
				
				// Get font character width.
				// If too long to fit and not in windowless mode then adjust width to fit remaining space.
				
				$charwidth=$charwidthtable[$font][$charcode]+1;
				if($linelengths[$linenum]+$charwidth>136&&!$windowless) {
					$charwidth=136-$linelengths[$linenum];
				}
				
				// Calculate font character x and y positions divided by 8. 
				
				$charxindex=$charcode%0x10;
				$charyindex=round(($charcode-$charxindex)/0x10);
				
				// Draw font character to canvas image.
				
				imagecopy($im,$fonts[$font],$linelengths[$linenum]+$texthorizontaloffset,($linenum*$textlineheight)+$textverticaloffset,$charxindex*8,$charyindex*8,$charwidth,8);
				$linelengths[$linenum]+=$charwidth;
			} else {
				
				// A font switching single byte placeholder was encountered.
				// Switch fonts.
				
				$font=$charcode-0x80;
				if($font>=$numberoffonts||$font<0) {
					$font=0;
				}
			}
		}
		$i++;
	}
}

// Fonts are no longer needed. Remove them from memory.

foreach($fontsloaded as $fontnum => $fontsloadedtest) {
	if($fontsloadedtest) {
		imagedestroy($fonts[$fontnum]);
	}
}


// Output final image.

header('Content-Type: image/png');
imagesavealpha($im,true);
imagepng($im);
imagedestroy($im);
?>